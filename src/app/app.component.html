<!-- Loading Spinner -->
<div *ngIf="shouldShowInitializationProgress()" class="loading-overlay">
  <div class="loading-content">
    <div class="spinner"></div>
    <div class="loading-info">
      <p>{{ loadingProgress }}</p>
      <small>L·∫ßn ƒë·∫ßu t·∫£i c√≥ th·ªÉ m·∫•t v√†i ph√∫t ƒë·ªÉ cache d·ªØ li·ªáu</small>
      <div class="cache-info" *ngIf="cacheInfo.isCached">
        <small>Cache: {{ getCacheSize() }} - {{ getCacheStatusText() }}</small>
      </div>
    </div>
  </div>
</div>

<!-- Main Container -->
<div class="container" [class.loading]="loading">
  <!-- Header -->
  <header class="header">
    <h1>H·ªá th·ªëng Tra c·ª©u ƒêi·ªÉm Thi THPT Qu·ªëc Gia</h1>
    <div class="controls">
      <button (click)="refreshData()" class="refresh-btn" [disabled]="loading || !initializationComplete">
        <span *ngIf="!loading">üîÑ L√†m m·ªõi</span>
        <span *ngIf="loading">‚è≥ ƒêang t·∫£i...</span>
      </button>
    </div>
  </header>

  <!-- Tab Navigation -->
  <nav class="tab-nav" *ngIf="initializationComplete">
    <button [class.active]="activeTab === 'overview'" (click)="setActiveTab('overview')" class="tab-btn">
      üìä T·ªïng quan
    </button>
    <button [class.active]="activeTab === 'search'" (click)="setActiveTab('search')" class="tab-btn">
      üîç T√¨m ki·∫øm
    </button>
    <button [class.active]="activeTab === 'statistics'" (click)="setActiveTab('statistics')" class="tab-btn">
      üìà Th·ªëng k√™
    </button>
    <button [class.active]="activeTab === 'comparison'" (click)="setActiveTab('comparison')" class="tab-btn">
      ‚öñÔ∏è So s√°nh
    </button>
  </nav>

  <!-- Content Area (only show when initialization is complete) -->
  <div *ngIf="initializationComplete" class="main-content">

    <!-- Overview Tab -->
    <div *ngIf="activeTab === 'overview'" class="tab-content">
      <!-- Filter Controls -->
      <div class="filter-section">
        <div class="filter-group">
          <label for="province">Ch·ªçn t·ªânh:</label>
          <select id="province" [(ngModel)]="selectedProvince" (change)="onProvinceChange()" [disabled]="loading">
            <option value="">T·∫•t c·∫£ t·ªânh</option>
            <option *ngFor="let province of provinces" [value]="province.ma_tinh">
              {{province.ten_tinh}}
            </option>
          </select>
        </div>

        <div class="filter-group">
          <label for="subject">Ch·ªçn m√¥n:</label>
          <select id="subject" [(ngModel)]="selectedSubject" (change)="onSubjectChange()" [disabled]="loading">
            <option *ngFor="let subject of getAvailableSubjects()" [value]="subject">
              {{getSubjectDisplayName(subject)}}
            </option>
          </select>
        </div>
      </div>

      <!-- Summary Cards -->
      <div class="summary-cards">
        <div class="card">
          <h3>T·ªïng s·ªë th√≠ sinh</h3>
          <p class="number">{{getTotalStudents() | number}}</p>
        </div>
        <div class="card">
          <h3>S·ªë t·ªânh/th√†nh</h3>
          <p class="number">{{getProvinceCount()}}</p>
        </div>
        <div class="card">
          <h3>T·ªïng s·ªë m√¥n thi</h3>
          <p class="number">{{getSubjectCount()}}</p>
        </div>
      </div>

      <!-- Top Provinces Chart -->
      <div class="chart-section">
        <h3>Top 10 t·ªânh c√≥ ƒëi·ªÉm trung b√¨nh cao nh·∫•t - {{getSubjectDisplayName(selectedSubject)}}</h3>
        <div class="chart-container">
          <div class="bar-chart" *ngIf="topProvinces && topProvinces.length > 0; else noData">
            <div *ngFor="let item of topProvinces" class="bar-item">
              <div class="bar-label">{{item.province}}</div>
              <div class="bar-wrapper">
                <div class="bar" [style.height.%]="(item.average / 10) * 100"></div>
                <span class="bar-value">{{item.average | number:'1.2-2'}}</span>
              </div>
            </div>
          </div>
          <ng-template #noData>
            <div class="no-data">Kh√¥ng c√≥ d·ªØ li·ªáu ƒë·ªÉ hi·ªÉn th·ªã</div>
          </ng-template>
        </div>
      </div>
    </div>

    <!-- Search Tab -->
    <div *ngIf="activeTab === 'search'" class="tab-content">
      <div class="search-section">
        <h3>T√¨m ki·∫øm theo s·ªë b√°o danh</h3>
        <div class="search-controls">
          <input type="text" [(ngModel)]="searchSBD" placeholder="Nh·∫≠p s·ªë b√°o danh (8 ch·ªØ s·ªë)..." class="search-input"
            maxlength="8" (keyup.enter)="searchStudent()" [disabled]="loading">
          <button (click)="searchStudent()" class="search-btn" [disabled]="!searchSBD.trim() || loading">
            <span *ngIf="!loading">üîç T√¨m ki·∫øm</span>
            <span *ngIf="loading">‚è≥ ƒêang t√¨m...</span>
          </button>
          <button (click)="clearSearch()" class="clear-btn" [disabled]="loading">
            X√≥a
          </button>
        </div>

        <!-- Search Results -->
        <div *ngIf="searchResult" class="search-results">
          <div class="result-card">
            <h4>K·∫øt qu·∫£ t√¨m ki·∫øm</h4>
            <p><strong>S·ªë b√°o danh:</strong> {{searchResult.student.SBD}}</p>
            <p><strong>T·ªânh/Th√†nh:</strong> {{searchResult.province}}</p>

            <div class="scores-table">
              <table>
                <thead>
                  <tr>
                    <th>M√¥n h·ªçc</th>
                    <th>ƒêi·ªÉm</th>
                  </tr>
                </thead>
                <tbody>
                  <tr *ngFor="let subject of getAvailableSubjects()">
                    <td>{{getSubjectDisplayName(subject)}}</td>
                    <td [class.high-score]="+searchResult.student[subject] >= 8"
                      [class.medium-score]="+searchResult.student[subject] >= 5 && +searchResult.student[subject] < 8"
                      [class.low-score]="+searchResult.student[subject] > 0 && +searchResult.student[subject] < 5">
                      {{
                      searchResult.student[subject] === -1 || searchResult.student[subject] === 0 ||
                      searchResult.student[subject] === null
                      ? 'Kh√¥ng thi'
                      : searchResult.student[subject]
                      }}
                    </td>
                  </tr>
                </tbody>
              </table>
            </div>
          </div>
        </div>

        <div *ngIf="searchHaveData" class="no-results">
          <p>‚ùå Kh√¥ng t√¨m th·∫•y th√≠ sinh v·ªõi s·ªë b√°o danh: <strong>{{searchSBD}}</strong></p>
          <small>Vui l√≤ng ki·ªÉm tra l·∫°i s·ªë b√°o danh (8 ch·ªØ s·ªë)</small>
        </div>
      </div>
    </div>

    <!-- Statistics Tab -->
    <div *ngIf="activeTab === 'statistics'" class="tab-content">
      <div class="statistics-section">
        <h3>Th·ªëng k√™ chi ti·∫øt theo t·ªânh</h3>

        <!-- Subject Selection -->
        <div class="subject-tabs">
          <button *ngFor="let subject of getAvailableSubjects()" [class.active]="selectedSubject === subject"
            (click)="selectedSubject = subject; onSubjectChange()" class="subject-tab" [disabled]="loading">
            {{getSubjectDisplayName(subject)}}
          </button>
        </div>

        <!-- Statistics Table -->
        <div class="statistics-table" *ngIf="getSubjectStats(selectedSubject).length > 0; else noStatsData">
          <table>
            <thead>
              <tr>
                <th>T·ªânh/Th√†nh</th>
                <th>S·ªë th√≠ sinh thi</th>
                <th>ƒêi·ªÉm TB</th>
                <th>ƒêi·ªÉm cao nh·∫•t</th>
                <th>S·ªë th√≠ sinh ƒëi·ªÉm cao nh·∫•t</th>
                <th>ƒêi·ªÉm th·∫•p nh·∫•t</th>
              </tr>
            </thead>
            <tbody>
              <tr *ngFor="let stat of getSubjectStats(selectedSubject); trackBy: trackByProvince">
                <td class="province-name">{{stat.province}}</td>
                <td>{{stat.count | number}}</td>
                <td [class.high-score]="stat.average >= 7" [class.medium-score]="stat.average >= 5 && stat.average < 7"
                  [class.low-score]="stat.average < 5">
                  {{stat.average | number:'1.2-2'}}
                </td>
                <td>{{stat.max | number:'1.2-2'}}</td>
                <td>{{stat.maxCount | number}}</td>
                <td>{{stat.min | number:'1.2-2'}}</td>
              </tr>
            </tbody>
          </table>
        </div>

        <ng-template #noStatsData>
          <div class="no-data">Kh√¥ng c√≥ d·ªØ li·ªáu th·ªëng k√™ cho m√¥n {{getSubjectDisplayName(selectedSubject)}}</div>
        </ng-template>

        <!-- Score Distribution -->
        <div class="distribution-section" *ngIf="getScoreDistribution(selectedSubject).length > 0">
          <h4>Ph√¢n b·ªë ƒëi·ªÉm {{getSubjectDisplayName(selectedSubject)}}</h4>
          <div class="distribution-chart">
            <div *ngFor="let range of getScoreDistribution(selectedSubject)" class="distribution-bar">
              <div class="range-label">{{range.range}}</div>
              <div class="progress-bar">
                <div class="progress-fill" [style.width.%]="range.percentage"></div>
              </div>
              <div class="range-stats">
                <span>{{range.count | number}} ({{range.percentage | number:'1.1-1'}}%)</span>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Comparison Tab -->
    <div *ngIf="activeTab === 'comparison'" class="tab-content">
      <div class="comparison-section">
        <h3>So s√°nh ƒëi·ªÉm trung b√¨nh c√°c m√¥n</h3>

        <!-- Province Comparison -->
        <div class="comparison-table" *ngIf="getDetailedStats().length > 0; else noComparisonData">
          <table>
            <thead>
              <tr>
                <th>T·ªânh/Th√†nh</th>
                <th *ngFor="let subject of getAvailableSubjects()">
                  {{getSubjectDisplayName(subject)}}
                </th>
              </tr>
            </thead>
            <tbody>
              <tr *ngFor="let stat of getDetailedStats()">
                <td class="province-name">{{stat.name}}</td>
                <td *ngFor="let subject of getAvailableSubjects()"
                  [class.high-score]="getSubjectAverage(stat, subject) >= 7"
                  [class.medium-score]="getSubjectAverage(stat, subject) >= 5 && getSubjectAverage(stat, subject) < 7"
                  [class.low-score]="getSubjectAverage(stat, subject) < 5 && getSubjectAverage(stat, subject) > 0">
                  {{getSubjectAverage(stat, subject) > 0 ? (getSubjectAverage(stat, subject) | number:'1.2-2') : '-'}}
                </td>
              </tr>
            </tbody>
          </table>
        </div>

        <ng-template #noComparisonData>
          <div class="no-data">Kh√¥ng c√≥ d·ªØ li·ªáu ƒë·ªÉ so s√°nh</div>
        </ng-template>

        <!-- Subject Comparison Chart -->
        <div class="subject-comparison" *ngIf="getAvailableSubjects().length > 0">
          <h4>Bi·ªÉu ƒë·ªì so s√°nh ƒëi·ªÉm trung b√¨nh c√°c m√¥n</h4>
          <div class="radar-chart">
            <div *ngFor="let subject of getAvailableSubjects()" class="subject-bar">
              <div class="subject-label">{{getSubjectDisplayName(subject)}}</div>
              <div class="subject-stats">
                <div class="avg-bar">
                  <div class="avg-fill" [style.width.%]="(getOverallAverage(subject) / 10) * 100"></div>
                  <span>{{getOverallAverage(subject) | number:'1.2-2'}}</span>
                </div>
              </div>
            </div>
          </div>
        </div>

        <!-- Top Performers -->
        <div class="top-performers">
          <h4>Top 5 t·ªânh c√≥ ƒëi·ªÉm cao nh·∫•t t·ª´ng m√¥n</h4>
          <div class="top-grid">
            <div *ngFor="let subject of getAvailableSubjects()" class="top-subject">
              <h5>{{getSubjectDisplayName(subject)}}</h5>
              <ol *ngIf="getTopProvinces(subject).length > 0; else noTopData">
                <li *ngFor="let province of getTopProvinces(subject).slice(0, 5)">
                  {{province.name}} - {{province.average | number:'1.2-2'}}
                </li>
              </ol>
              <ng-template #noTopData>
                <p class="no-data-small">Kh√¥ng c√≥ d·ªØ li·ªáu</p>
              </ng-template>
            </div>
          </div>
        </div>
      </div>
    </div>

  </div>

  <!-- Footer with system info -->
  <footer class="footer" *ngIf="initializationComplete">
    <div class="system-info">
      <span>H·ªá th·ªëng tra c·ª©u ƒëi·ªÉm thi THPT Qu·ªëc Gia 2025</span>
      <span class="separator">|</span>
      <span>D·ªØ li·ªáu: {{provinces.length}} t·ªânh/th√†nh c≈©</span>
      <span class="separator">|</span>
      <span>D·ªØ li·ªáu ƒë∆∞·ª£c t·ªïng h·ª£p t·∫°i <a href="https://github.com/harveycdr/DiemThiTHPT2025" target="_blank"
          rel="noopener noreferrer" style="color: blue">Tu·ªïi tr·∫ª online</a>
      </span>
      <span class="separator">|</span>
      <span>D·ªØ li·ªáu ƒë∆∞·ª£c t·ªïng h·ª£p c√≥ th·ªÉ kh√¥ng ch√≠nh x√°c
      </span>
    </div>
    <div class="version-info">
      <small>&copy; 2024 TDT Dev TechShop</small>
      <span class="separator">|</span>
      <small>Li√™n h·ªá fb: <a href="https://www.facebook.com/techshoptdt" target="_blank" rel="noopener noreferrer"
          style="color: blue">TECH SHOP - TDT DEV</a></small>
    </div>
  </footer>

</div>